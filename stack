#!/usr/bin/env bash
set -e

STACK_ROOT="stacks"
SHARED_NETWORK="homelab_network"

if ! docker network inspect "$SHARED_NETWORK" >/dev/null 2>&1; then
    echo "Creating Docker network: $SHARED_NETWORK"
    docker network create "$SHARED_NETWORK"
fi

if [[ -f .env.global ]]; then
    set -a
    source .env.global
    set +a
fi

if [[ -f .env.secrets ]]; then
    set -a
    source .env.secrets
    set +a
fi

run_stack() {
    local stack="$1"
    local cmd="$2"
    shift 2
    local extra_args=("$@")

    local compose_file="$STACK_ROOT/$stack/docker-compose.yaml"
    local env_file="$STACK_ROOT/$stack/.env"

    [[ ! -f "$compose_file" ]] && return 0

    echo
    echo "=== $cmd -> $stack ==="

    if [[ -f "$env_file" ]]; then
        docker compose \
            --project-name "$stack" \
            --env-file "$env_file" \
            -f "$compose_file" \
            $cmd "${extra_args[@]}"
    else
        docker compose \
            --project-name "$stack" \
            -f "$compose_file" \
            $cmd "${extra_args[@]}"
    fi
}

ACTION="$1"
TARGET="$2"
shift 2 || true

if [[ "$ACTION" == "up" ]]; then
    EXTRA_ARGS=("-d" "$@")
else
    EXTRA_ARGS=("$@")
fi

if [[ -z "$ACTION" || -z "$TARGET" ]]; then
    echo "Usage: ./deploy.sh <up|down|pull|restart> <all|stackname> [extra docker args]"
    exit 1
fi

if [[ "$TARGET" == "all" ]]; then
    for stack in $(ls "$STACK_ROOT"); do
        run_stack "$stack" "$ACTION" "${EXTRA_ARGS[@]}"
    done
    exit 0
fi

if [[ -d "$STACK_ROOT/$TARGET" ]]; then
    run_stack "$TARGET" "$ACTION" "${EXTRA_ARGS[@]}"
    exit 0
fi

echo "Stack '$TARGET' not found."
exit 1